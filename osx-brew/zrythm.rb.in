# Copyright (C) 2020-2021, 2024 Alexandros Theodotou <alex at zrythm dot org>
#
# This file is part of Zrythm
#
# Zrythm is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Zrythm is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with Zrythm.  If not, see <https://www.gnu.org/licenses/>.
#
class Zrythm@TRIAL_INITIAL_UPPERCASE@ < Formula
  desc "Digital audio workstation"
  homepage "https://www.zrythm.org"
  url "@ZRYTHM_ORIG_SRC_TARBALL_URL@"
  sha256 "@ZRYTHM_BREW_SHA256@"
  version "@ZRYTHM_PKG_VERSION@"

  depends_on "ccache" => :build
  depends_on "meson" => :build
  depends_on "ninja" => :build
  depends_on "pkg-config" => :build
  depends_on "help2man" => :build
  depends_on "cmake" => :build
  depends_on "gnu-sed" => :build
  depends_on "sassc" => :build
  depends_on "glib-utils" => :build
  depends_on "guile" => :build
  depends_on "itstool" => :build
  depends_on "boost"
  depends_on "curl"
  depends_on "libyaml"
  depends_on "fftw"
  depends_on "libsamplerate"
  depends_on "libsndfile"
  depends_on "libsass"
  depends_on "libxmlb"
  #depends_on "libxslt"
  depends_on "lilv"
  depends_on "librsvg"
  depends_on "gtksourceview5"
  depends_on "googletest"
  #depends_on "graphviz"
  depends_on "rubberband"
  depends_on "sdl2"
  depends_on "rt-audio"
  depends_on "rtmidi"
  depends_on "zstd"
  depends_on "carla-git"
  depends_on "jack"
  depends_on "qjackctl"
  depends_on "pcre2"
  depends_on "xxhash"
  depends_on "vamp-plugin-sdk"
  depends_on "appstream"
  depends_on "libsoxr"
  depends_on "yyjson"
  depends_on "shaderc"
  depends_on "gtkmm4"
  depends_on "libpanel"
  depends_on "magic_enum"
  depends_on "fmt"
  depends_on "spdlog"

  def install
    mkdir "build" do

      # configure
      system "cmake", "-S", "..", "-B", ".",
        "-G", "Ninja",
        "-DCMAKE_INSTALL_PREFIX=#{prefix}",
        "-DCMAKE_INSTALL_LIBDIR=#{lib}",
        #"-Dextra_debug_info=true",
        "-DCMAKE_BUILD_TYPE=RelWithDebInfo",
        "-DZRYTHM_TESTS=OFF",
        "-DZRYTHM_MAINTAINER_MODE=ON",
        "-DZRYTHM_IS_INSTALLER_VER=ON",
        "-DZRYTHM_IS_TRIAL_VER=@TRIAL_TRUE_FALSE@",
        "-DZRYTHM_WITH_X11=OFF",
        "-DZRYTHM_WITH_RTMIDI=ON",
        "-DZRYTHM_WITH_RTAUDIO=ON",
        "-DZRYTHM_PACKAGE_VERSION=@ZRYTHM_PKG_SEMVER_VERSION@",
        # manpage fails
        "-DZRYTHM_MANPAGE=OFF",
        "-DZRYTHM_CHECK_UPDATES=ON",
        #"-Dvamp_static=true",
        "-DZRYTHM_CARLA_WITH_CV32_PATCHBAY_VARIANT=ON",
        "-DCMAKE_DISABLE_PRECOMPILE_HEADERS=ON",
        #*std_cmake_args
        "-DCMAKE_FIND_FRAMEWORK=LAST",
        "-DCMAKE_VERBOSE_MAKEFILE=ON",
        "-DBUILD_TESTING=OFF",
        #"-DCMAKE_OSX_SYSROOT=/Library/Developer/CommandLineTools/SDKs/MacOSX13.sdk"
        "-DCMAKE_OSX_SYSROOT=/Applications/Xcode_15.2.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk"

      # build
      system "cmake", "--build", ".", "--verbose"

      # install
      system "cmake", "--install", "."

      #system "cp", "-r", "@BREEZE_DARK@", "#{share}/icons/breeze-dark"
      system "mkdir", "-p", "#{lib}/zrythm/carla"
      system "mkdir", "-p", "#{lib}/lv2"
      system "cp", "-RLv", "@BUILT_ZPLUGINS_DIR@/lib/lv2", "#{lib}/"
      system "mkdir", "-p", "#{prefix}/LICENSES"
      system "cp", "-RLv", "../LICENSES", "#{prefix}/"
    end
  end

  test do
    system "#{bin}/zrythm", "--version"
  end
end
