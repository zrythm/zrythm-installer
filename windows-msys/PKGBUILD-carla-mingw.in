# Copyright (C) 2021-2022 Alexandros Theodotou <alex at zrythm dot org>
#
# This file is part of Zrythm
#
# Zrythm is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Zrythm is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with Zrythm.  If not, see <https://www.gnu.org/licenses/>.
#
# Maintainer: Alexandros Theodotou <alex at zrythm dot org>
_realname=carla
pkgbase=mingw-w64-${_realname}
pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}"
pkgver=2.6.0
pkgrel=1
arch=('any')
pkgdesc='carla'
depends=("${MINGW_PACKAGE_PREFIX}-fluidsynth"
         "${MINGW_PACKAGE_PREFIX}-liblo")
makedepends=("${MINGW_PACKAGE_PREFIX}-ccache"
             "${MINGW_PACKAGE_PREFIX}-cc"
             "${MINGW_PACKAGE_PREFIX}-cmake"
             "${MINGW_PACKAGE_PREFIX}-ninja"
             "tree"
             "${MINGW_PACKAGE_PREFIX}-pkg-config")
options=('!strip')
license=("GPL2")
url="https://github.com/falktx/carla"
source=("Carla-@CARLA_GIT_VER@.tar.gz")
sha256sums=('SKIP')

prepare() {
  ls
  rm -rf ${_realname}-${pkgver}
  mv "Carla-@CARLA_GIT_VER@" ${_realname}-${pkgver}
  cd ${_realname}-${pkgver}
  make msys2fix
}

build() {
  mkdir -p "${srcdir}/build-${MSYSTEM}" && cd "${srcdir}/build-${MSYSTEM}"

  CFLAGS+=" -mtune=haswell"
  CXXFLAGS+=" -mtune=haswell"

  MSYS2_ARG_CONV_EXCL="-DCMAKE_INSTALL_PREFIX=" \
  ${MINGW_PREFIX}/bin/cmake \
    -GNinja \
    -DCMAKE_INSTALL_PREFIX=${MINGW_PREFIX} \
    -DCMAKE_BUILD_TYPE=RelWithDebInfo \
    -DCMAKE_C_FLAGS=-Duint="\"unsigned int\"" \
    -DBUILD_SHARED_LIBS=ON \
    -DCARLA_BUILD_STATIC=false \
    ../${_realname}-${pkgver}/cmake

  ${MINGW_PREFIX}/bin/cmake --build .

  #if [ "$MINGW_ARCH" = "mingw32" ]; then
    #make "${common_args[@]}" win32r
  #else
    #make "${common_args[@]}"
  #fi
}

package() {
  pushd "${srcdir}/build-${MSYSTEM}"
  DESTDIR="${pkgdir}" ${MINGW_PREFIX}/bin/cmake --install .
  popd

  pushd "${srcdir}/${_realname}-${pkgver}"

  tree "${pkgdir}/${MINGW_PREFIX}"
  #mkdir -p "${pkgdir}/${MINGW_PREFIX}"/lib/carla
  #ls -l bin
  #install -D -m755 bin/*.exe "${pkgdir}/${MINGW_PREFIX}"/lib/carla/

  #if [ "$MINGW_ARCH" != "mingw32" ]; then
    #make DESTDIR=${pkgdir} PREFIX="${MINGW_PREFIX}" install
  #fi
}
